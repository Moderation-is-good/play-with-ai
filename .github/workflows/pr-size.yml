name: PR Size Labels

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  size-label:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate PR size
        id: size
        run: |
          BASE=${{ github.event.pull_request.base.sha }}
          HEAD=${{ github.event.pull_request.head.sha }}

          # Get additions and deletions
          STATS=$(git diff --shortstat $BASE..$HEAD)
          ADDITIONS=$(echo "$STATS" | grep -oP '\d+(?= insertion)' || echo "0")
          DELETIONS=$(echo "$STATS" | grep -oP '\d+(?= deletion)' || echo "0")
          TOTAL=$((ADDITIONS + DELETIONS))

          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # Determine size label
          if [ $TOTAL -lt 10 ]; then
            echo "label=size/XS" >> $GITHUB_OUTPUT
            echo "color=3CBF00" >> $GITHUB_OUTPUT
          elif [ $TOTAL -lt 50 ]; then
            echo "label=size/S" >> $GITHUB_OUTPUT
            echo "color=5D9801" >> $GITHUB_OUTPUT
          elif [ $TOTAL -lt 200 ]; then
            echo "label=size/M" >> $GITHUB_OUTPUT
            echo "color=7F7203" >> $GITHUB_OUTPUT
          elif [ $TOTAL -lt 500 ]; then
            echo "label=size/L" >> $GITHUB_OUTPUT
            echo "color=A14C05" >> $GITHUB_OUTPUT
          else
            echo "label=size/XL" >> $GITHUB_OUTPUT
            echo "color=C32607" >> $GITHUB_OUTPUT
          fi

      - name: Remove old size labels
        run: |
          gh pr edit ${{ github.event.pull_request.number }} \
            --remove-label "size/XS" \
            --remove-label "size/S" \
            --remove-label "size/M" \
            --remove-label "size/L" \
            --remove-label "size/XL" || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add size label
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --add-label "${{ steps.size.outputs.label }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on large PRs
        if: steps.size.outputs.total >= 500
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "⚠️ **Large PR Warning**

          This PR has **${{ steps.size.outputs.total }}** lines changed (+${{ steps.size.outputs.additions }}/-${{ steps.size.outputs.deletions }}).

          Consider breaking it into smaller PRs for easier review."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
